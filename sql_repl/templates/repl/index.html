<!DOCTYPE html>
<html>
<head>
    <title>SQL REPL - Playground</title>
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background-color: #f8f9fa; }
        
        nav { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1.5rem; background: #2d3436; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        nav a { color: #81ecec; text-decoration: none; font-weight: bold; }
        
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar Styling */
        .sidebar { width: 300px; background: #ffffff; border-right: 1px solid #dee2e6; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1rem; border-bottom: 1px solid #eee; background: #f1f3f5; font-weight: bold; }
        .history-list { flex: 1; overflow-y: auto; list-style: none; margin: 0; padding: 0; }
        .history-item { padding: 12px 15px; border-bottom: 1px solid #f1f1f1; cursor: pointer; transition: background 0.2s; }
        .history-item:hover { background: #f8f9fa; }
        .history-item small { color: #636e72; display: block; margin-bottom: 4px; font-size: 0.75rem; }
        .history-item code { color: #0984e3; font-family: monospace; font-size: 0.85rem; word-break: break-all; }

        /* Editor & Results Area */
        .content { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .editor-container { border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .CodeMirror { height: 250px; font-size: 16px; }
        
        .controls { margin: 15px 0; display: flex; gap: 10px; }
        .btn { padding: 10px 25px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        .btn-run { background: #00b894; color: white; }
        .btn-clear { background: #636e72; color: white; }
        .btn:hover { opacity: 0.9; }

        /* Data Table */
        .results-container { margin-top: 20px; background: white; border-radius: 8px; border: 1px solid #dee2e6; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f3f5; color: #2d3436; text-align: left; padding: 12px; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #eee; color: #2d3436; }
        tr:last-child td { border-bottom: none; }
        .error-msg { background: #ff7675; color: white; padding: 15px; border-radius: 4px; margin-top: 10px; }
    </style>
</head>
<body>

    <nav>
        <div><strong>SQL_REPL</strong></div>
        <div>
            {% if user.is_authenticated %}
                <span>Welcome, <strong>{{ user.username }}</strong></span> | 
                <!-- Explicitly pointing to /accounts/logout/ to match core/urls.py -->
                <form action="/accounts/logout/" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" style="background:none; border:none; color:#ff7675; cursor:pointer; font-weight:bold;">Logout</button>
                </form>
            {% else %}
                <!-- Explicitly pointing to /accounts/login/ to avoid 404s at /login/ -->
                <a href="/accounts/login/">Login to save queries</a>
            {% endif %}
        </div>
    </nav>

    <div class="main-container">
        <!-- Sidebar for History -->
        <div class="sidebar">
            <div class="sidebar-header">Query History</div>
            <ul class="history-list">
                {% if user.is_authenticated %}
                    {% for item in history %}
                    <li class="history-item" onclick="loadQuery(`{{ item.code|escapejs }}`)">
                        <small>{{ item.created_at|date:"M d, Y H:i" }}</small>
                        <code>{{ item.code|truncatechars:60 }}</code>
                    </li>
                    {% empty %}
                    <li class="history-item"><small>No saved queries yet.</small></li>
                    {% endfor %}
                {% else %}
                    <li class="history-item">
                        <small>Guest Mode</small>
                        <p style="font-size: 0.8rem; color: #636e72;">Log in to persist your queries across sessions.</p>
                    </li>
                {% endif %}
            </ul>
        </div>

        <!-- Main Workspace -->
        <div class="content">
            <form method="POST" id="sqlForm">
                {% csrf_token %}
                <div class="editor-container">
                    <textarea id="editor" name="query">{{ query }}</textarea>
                </div>
                <div class="controls">
                    <button type="submit" class="btn btn-run">Execute SQL</button>
                    <button type="button" class="btn btn-clear" onclick="editor.setValue('')">Clear</button>
                </div>
            </form>

            {% if error %}
                <div class="error-msg"><strong>Error:</strong> {{ error }}</div>
            {% endif %}

            {% if results %}
            <div class="results-container">
                <table>
                    <thead>
                        <tr>{% for col in columns %}<th>{{ col }}</th>{% endfor %}</tr>
                    </thead>
                    <tbody>
                        {% for row in results %}
                        <tr>{% for cell in row %}<td>{{ cell }}</td>{% endfor %}</tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/sql/sql.min.js"></script>
    
    <script>
        var editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
            mode: "text/x-sql",
            theme: "dracula",
            lineNumbers: true,
            indentWithTabs: true,
            smartIndent: true,
            autofocus: true
        });

        // Helper: Load history into editor
        function loadQuery(code) {
            editor.setValue(code);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // GUEST FEATURE: Save to LocalStorage
        document.getElementById('sqlForm').onsubmit = function() {
            localStorage.setItem('guest_last_query', editor.getValue());
        };

        window.onload = function() {
            // Priority: 1. Current query in context, 2. LocalStorage for guests
            if (!editor.getValue() && localStorage.getItem('guest_last_query')) {
                editor.setValue(localStorage.getItem('guest_last_query'));
            }
        };
    </script>
</body>
</html>